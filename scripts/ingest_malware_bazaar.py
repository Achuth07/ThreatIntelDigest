import os
import requests
import zipfile
import io
import csv
import boto3
import psycopg2
from datetime import datetime, timedelta
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Configuration
MALWARE_BAZAAR_URL = "https://bazaar.abuse.ch/export/csv/recent/"
R2_BUCKET_NAME = os.getenv("R2_BUCKET_NAME")
R2_ENDPOINT_URL = os.getenv("R2_ENDPOINT_URL")
R2_ACCESS_KEY_ID = os.getenv("R2_ACCESS_KEY_ID")
R2_SECRET_ACCESS_KEY = os.getenv("R2_SECRET_ACCESS_KEY")
DATABASE_URL = os.getenv("DATABASE_URL")

def get_db_connection():
    """Establishes a connection to the PostgreSQL database."""
    return psycopg2.connect(DATABASE_URL)

def upload_to_r2(content, filename):
    """Uploads content to Cloudflare R2."""
    if not all([R2_BUCKET_NAME, R2_ENDPOINT_URL, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY]):
        print("Skipping R2 upload: Missing credentials.")
        return

    s3 = boto3.client(
        's3',
        endpoint_url=R2_ENDPOINT_URL,
        aws_access_key_id=R2_ACCESS_KEY_ID,
        aws_secret_access_key=R2_SECRET_ACCESS_KEY
    )
    
    try:
        s3.put_object(Bucket=R2_BUCKET_NAME, Key=f"malware/{filename}", Body=content)
        print(f"Successfully uploaded {filename} to R2.")
    except Exception as e:
        print(f"Failed to upload to R2: {e}")

def process_and_ingest():
    """Downloads, parses, and ingests malware data."""
    print("Downloading daily malware batch...")
    headers = {
        "User-Agent": "ThreatIntelDigest/1.0 (Research Project)"
    }
    response = requests.get(MALWARE_BAZAAR_URL, headers=headers)
    response.raise_for_status()
    
    print(f"Response status: {response.status_code}")
    print(f"Response headers: {response.headers}")
    print(f"Content start: {response.content[:20]}")

    # Archive raw content to R2
    today_str = datetime.now().strftime("%Y-%m-%d")
    upload_to_r2(response.content, f"{today_str}.csv")

    # Process CSV in-memory
    family_counts = {}
    
    print("Processing CSV data...")
    # Decode directly
    content = io.StringIO(response.content.decode('utf-8', errors='replace'))
    
    # Skip comments (lines starting with #)
    reader = csv.reader(filter(lambda x: not x.startswith('#'), content))
    
    for row in reader:
        if not row: continue
        
        try:
            # Index 8 is 'signature' (e.g., CobaltStrike, Heodo)
            if len(row) > 8:
                signature = row[8]
                if signature and signature != "n/a":
                     # Clean the signature: remove quotes and whitespace
                     signature = signature.replace('"', '').strip()
                     if signature and signature != "n/a":
                        family_counts[signature] = family_counts.get(signature, 0) + 1
        except Exception as e:
            continue

    print(f"Aggregated {len(family_counts)} unique malware families.")

    # Insert into Database
    conn = get_db_connection()
    cur = conn.cursor()
    
    try:
        inserted_count = 0
        current_date = datetime.now().date()
        
        for family, count in family_counts.items():
            # Basic type inference (could be improved with a mapping)
            malware_type = "Malware" 
            
            cur.execute("""
                INSERT INTO malware_daily_stats (date, family_name, sample_count, malware_type)
                VALUES (%s, %s, %s, %s)
            """, (current_date, family, count, malware_type))
            inserted_count += 1
            
        conn.commit()
        print(f"Successfully inserted {inserted_count} records into malware_daily_stats.")
        
    except Exception as e:
        conn.rollback()
        print(f"Database error: {e}")
    finally:
        cur.close()
        conn.close()

if __name__ == "__main__":
    process_and_ingest()
