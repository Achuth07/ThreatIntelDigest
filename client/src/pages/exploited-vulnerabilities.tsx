
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { apiRequest } from '@/lib/queryClient';
import { KEVCard } from '@/components/kev-card';
import { Button } from '@/components/ui/button';
import { Shield, RefreshCw, Filter } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { KnownExploitedVulnerability } from '@shared/schema';
import { useLocation } from 'wouter';
import { SEO } from '@/components/seo';
import { Header } from '@/components/header';
import { Sidebar } from '@/components/sidebar';
import { getAuthenticatedUser } from '@/lib/auth';
import { Bookmark, Article } from '@shared/schema';
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from '@/components/ui/sheet';
import { Loader2, ExternalLink } from 'lucide-react';
import { format } from 'date-fns';

export default function ExploitedVulnerabilitiesPage() {
    const [page, setPage] = useState(1);
    const [vendorFilter, setVendorFilter] = useState<string>('all');
    const [ransomwareFilter, setRansomwareFilter] = useState<string>('all');
    const [sort, setSort] = useState<string>('newest');
    const [location, setLocation] = useLocation();
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);
    const [activeCve, setActiveCve] = useState<string | null>(null);

    const user = getAuthenticatedUser();

    // Fetch bookmarks for header
    const { data: bookmarks = [] } = useQuery<Bookmark[]>({
        queryKey: ['/api/bookmarks'],
        enabled: !!user && !!user.token,
    });

    const handleSearch = (query: string) => {
        // Navigate to home for article search (could be improved to pass query)
        setLocation('/');
    };

    const handleBookmarksClick = () => {
        setLocation('/');
    };

    const handleSidebarToggle = () => {
        setIsSidebarOpen(!isSidebarOpen);
    };

    const handleSidebarClose = () => {
        setIsSidebarOpen(false);
    };

    const navigateToFeed = (params?: Record<string, string>) => {
        const query = params ? `?${new URLSearchParams(params).toString()}` : '';
        setLocation(`/threatfeed${query}`);
    };


    // Fetch KEV data
    const { data: kevData, isLoading, refetch } = useQuery<{ data: KnownExploitedVulnerability[], page: number, limit: number }>({
        queryKey: ['/api/kev', { page, vendorFilter, ransomwareFilter, sort }],
        queryFn: async () => {
            const params = new URLSearchParams({
                page: page.toString(),
                limit: '50',
                sort
            });
            if (vendorFilter !== 'all') params.append('vendorProject', vendorFilter);
            if (ransomwareFilter !== 'all') params.append('knownRansomwareCampaignUse', ransomwareFilter);

            const res = await apiRequest('GET', `/api/kev?${params}`);
            return res.json();
        }
    });

    // Fetch Vendors for filter
    const { data: vendorsData } = useQuery<{ vendorProject: string, count: number }[]>({
        queryKey: ['/api/kev/vendors'],
        queryFn: async () => {
            const res = await apiRequest('GET', '/api/kev/vendors');
            return res.json();
        }
    });

    // Fetch related news for active CVE
    const { data: relatedNews, isLoading: isNewsLoading } = useQuery<Article[]>({
        queryKey: ['/api/kev', activeCve, 'related-articles'],
        enabled: !!activeCve,
        queryFn: async () => {
            if (!activeCve) return [];
            const res = await apiRequest('GET', `/api/kev/${activeCve}/related-articles?limit=10`);
            return res.json();
        }
    });

    const handleNextPage = () => setPage(p => p + 1);
    const handlePrevPage = () => setPage(p => Math.max(1, p - 1));

    const handleCardClick = (cveID: string) => {
        setLocation(`/exploited-vulnerabilities/${cveID}`);
    };

    const handleRelatedNewsClick = (cveID: string) => {
        setActiveCve(cveID);
    };

    return (
        <div className="min-h-screen bg-whatcyber-darker text-slate-100 flex flex-col">
            <SEO
                title="Exploited Vulnerabilities (KEV) | WhatCyber"
                description="CISA Known Exploited Vulnerabilities catalog dashboard. Track active threats, ransomware campaigns, and remediation deadlines."
                keywords="CISA KEV, exploited vulnerabilities, active exploitation, ransomware, cve, security dashboard"
            />

            <Header
                onSearch={handleSearch}
                bookmarkCount={bookmarks.length}
                onBookmarksClick={handleBookmarksClick}
                onSidebarToggle={handleSidebarToggle}
                isSidebarOpen={isSidebarOpen}
            />

            <div className="flex flex-1 min-h-0 relative">
                {/* Mobile Overlay */}
                {isSidebarOpen && (
                    <div
                        className="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden"
                        onClick={handleSidebarClose}
                    />
                )}

                {/* Sidebar */}
                <div className={`${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                    } fixed left-0 top-16 h-[calc(100vh-4rem)] z-30 lg:relative lg:translate-x-0 lg:z-10 lg:top-0 lg:h-full transition-transform duration-300 ease-in-out`}>
                    <Sidebar
                        selectedSource="all"
                        onSourceSelect={(source) => navigateToFeed({ source })}
                        timeFilter="all"
                        onTimeFilterChange={(filter) => navigateToFeed({ timeFilter: filter })}
                        threatFilters={[]}
                        onThreatFilterChange={(filters) => navigateToFeed({ threatFilters: filters.join(',') })}
                        onClose={handleSidebarClose}
                        onVulnerabilitiesClick={() => navigateToFeed({ view: 'cveList' })}
                        onFollowSourcesClick={() => navigateToFeed({ view: 'followSources' })}
                        onBookmarksClick={() => navigateToFeed({ view: 'bookmarks' })}
                    />
                </div>

                <main className="flex-1 overflow-y-auto bg-whatcyber-darker">
                    <div className="p-4 lg:p-6 pb-20">
                        <div className="flex flex-col gap-6 max-w-7xl mx-auto">

                            {/* Header */}
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <h1 className="text-2xl font-bold flex items-center text-slate-100">
                                        <Shield className="w-6 h-6 text-red-500 mr-2" />
                                        Exploited Vulnerabilities (KEV)
                                    </h1>
                                    <p className="text-slate-400 mt-1">
                                        CISA Known Exploited Vulnerabilities Catalog
                                    </p>
                                </div>

                                <div className="flex items-center gap-2">
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        className="border-slate-600 text-slate-300 hover:text-slate-100 min-w-[100px]"
                                        onClick={() => refetch()}
                                    >
                                        <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                                        Refresh
                                    </Button>
                                </div>
                            </div>

                            {/* Filters */}
                            <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50 flex flex-col md:flex-row gap-4 items-center">
                                <div className="w-full md:w-auto flex items-center gap-2 text-slate-400 text-sm font-medium">
                                    <Filter className="w-4 h-4" />
                                    Filters:
                                </div>

                                <Select value={vendorFilter} onValueChange={(v) => { setVendorFilter(v); setPage(1); }}>
                                    <SelectTrigger className="w-full md:w-[200px] bg-slate-900 border-slate-700 text-slate-200">
                                        <SelectValue placeholder="Vendor" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="all">All Vendors</SelectItem>
                                        {vendorsData?.map(v => (
                                            <SelectItem key={v.vendorProject} value={v.vendorProject}>
                                                {v.vendorProject} ({v.count})
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>

                                <Select value={ransomwareFilter} onValueChange={(v) => { setRansomwareFilter(v); setPage(1); }}>
                                    <SelectTrigger className="w-full md:w-[220px] bg-slate-900 border-slate-700 text-slate-200">
                                        <SelectValue placeholder="Ransomware Used" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="all">All Statuses</SelectItem>
                                        <SelectItem value="Known">Known Ransomware Use</SelectItem>
                                        <SelectItem value="Unknown">Unknown</SelectItem>
                                    </SelectContent>
                                </Select>

                                <Select value={sort} onValueChange={(v) => { setSort(v); setPage(1); }}>
                                    <SelectTrigger className="w-full md:w-[150px] bg-slate-900 border-slate-700 text-slate-200 md:ml-auto">
                                        <SelectValue placeholder="Sort" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="newest">Newest Added</SelectItem>
                                        <SelectItem value="oldest">Oldest Added</SelectItem>
                                    </SelectContent>
                                </Select>
                            </div>

                            {/* Content */}
                            {isLoading ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {[...Array(6)].map((_, i) => (
                                        <div key={i} className="h-64 bg-slate-800/50 rounded-lg animate-pulse border border-slate-700/50" />
                                    ))}
                                </div>
                            ) : !kevData?.data?.length ? (
                                <div className="text-center py-20 text-slate-500">
                                    <Shield className="w-12 h-12 mx-auto mb-4 opacity-20" />
                                    <p className="text-lg">No vulnerabilities found matching your filters.</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {kevData.data.map(kev => (
                                        <div key={kev.cveID} onClick={() => handleCardClick(kev.cveID)} className="cursor-pointer">
                                            <KEVCard
                                                kev={kev}
                                                onRelatedNewsClick={handleRelatedNewsClick}
                                            />
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Pagination */}
                            {kevData?.data && (
                                <div className="flex justify-center gap-4 mt-8">
                                    <Button
                                        variant="outline"
                                        onClick={handlePrevPage}
                                        disabled={page === 1}
                                        className="border-slate-700 text-slate-300"
                                    >
                                        Previous
                                    </Button>
                                    <span className="flex items-center px-4 text-slate-400">Page {page}</span>
                                    <Button
                                        variant="outline"
                                        onClick={handleNextPage}
                                        disabled={kevData.data.length < 50}
                                        className="border-slate-700 text-slate-300"
                                    >
                                        Next
                                    </Button>
                                </div>
                            )}
                        </div>
                    </div>
                </main>

                {/* Related News Sheet */}
                <Sheet open={!!activeCve} onOpenChange={(open) => !open && setActiveCve(null)}>
                    <SheetContent className="w-full sm:max-w-xl bg-whatcyber-darker border-l border-slate-800 p-0 text-slate-100">
                        <SheetHeader className="p-6 border-b border-slate-800 bg-slate-900/50">
                            <SheetTitle className="text-xl font-bold flex items-center gap-2 text-slate-100">
                                <Shield className="w-5 h-5 text-whatcyber-teal" />
                                Related Intelligence
                            </SheetTitle>
                            <SheetDescription className="text-slate-400">
                                Recent articles and analysis for {activeCve}
                            </SheetDescription>
                        </SheetHeader>

                        <div className="p-6 overflow-y-auto h-[calc(100vh-100px)]">
                            {isNewsLoading ? (
                                <div className="flex flex-col items-center justify-center py-12 text-slate-500 gap-3">
                                    <Loader2 className="w-8 h-8 animate-spin text-whatcyber-teal" />
                                    <p className="text-sm">Scanning sources...</p>
                                </div>
                            ) : !relatedNews?.length ? (
                                <div className="text-center py-12 bg-slate-800/30 rounded-lg border border-dashed border-slate-700/50">
                                    <p className="text-slate-400 mb-2">No specific articles found</p>
                                    <p className="text-xs text-slate-500">
                                        We couldn't find any recent articles specifically referencing this CVE ID.
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {relatedNews.map((article) => (
                                        <a
                                            key={article.id}
                                            href={article.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="block bg-slate-800/80 hover:bg-slate-800 border-l-2 border-l-transparent hover:border-l-whatcyber-teal border-y border-r border-slate-700/50 rounded-lg p-4 transition-all group"
                                        >
                                            <h4 className="font-semibold text-slate-200 group-hover:text-whatcyber-teal transition-colors mb-2 line-clamp-2">
                                                {article.title}
                                            </h4>

                                            <div className="flex items-center justify-between text-xs text-slate-500 mt-3">
                                                <div className="flex items-center gap-2">
                                                    <span className={`w-2 h-2 rounded-full ${article.threatLevel === 'HIGH' || article.threatLevel === 'CRITICAL' ? 'bg-red-500' :
                                                        article.threatLevel === 'MEDIUM' ? 'bg-orange-500' : 'bg-blue-500'
                                                        }`} />
                                                    <span className="font-medium text-slate-400">{article.source}</span>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <span>{format(new Date(article.publishedAt), 'MMM dd')}</span>
                                                    <ExternalLink className="w-3 h-3 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                </div>
                                            </div>
                                        </a>
                                    ))}
                                </div>
                            )}
                        </div>
                    </SheetContent>
                </Sheet>
            </div>
        </div>
    );
}
