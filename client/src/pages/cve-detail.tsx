import { useRoute, useLocation } from "wouter";
import { useQuery } from '@tanstack/react-query';
import { apiRequest } from '@/lib/queryClient';
import { KnownExploitedVulnerability, Article, Vulnerability } from '@shared/schema';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Shield, AlertTriangle, Calendar, Activity, Newspaper, ExternalLink, Clock, Server, AlertCircle, CheckCircle, Info } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { format } from 'date-fns';
import { Loader2 } from 'lucide-react';
import { SEO } from '@/components/seo';
import { Header } from '@/components/header';
import { Sidebar } from '@/components/sidebar';
import { useState } from 'react';
import { getAuthenticatedUser } from '@/lib/auth';
import { Bookmark } from '@shared/schema';
import { Progress } from '@/components/ui/progress';

interface KevResponse {
    kev: KnownExploitedVulnerability | null;
    nvd: Vulnerability | null;
}

export default function CVEDetailPage() {
    const [matchKev, paramsKev] = useRoute("/exploited-vulnerabilities/:id");
    const [matchVuln, paramsVuln] = useRoute("/vulnerabilities/:id");
    const params = matchKev ? paramsKev : matchVuln ? paramsVuln : null;
    const [location, setLocation] = useLocation();
    const cveId = params?.id;
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);

    const user = getAuthenticatedUser();

    // Fetch bookmarks for header
    const { data: bookmarks = [] } = useQuery<Bookmark[]>({
        queryKey: ['/api/bookmarks'],
        enabled: !!user && !!user.token,
    });

    const { data: cveData, isLoading: isKevLoading } = useQuery<KevResponse>({
        queryKey: ['/api/vulnerabilities', cveId],
        queryFn: async () => {
            if (!cveId) throw new Error("No CVE ID");
            const res = await apiRequest('GET', `/api/vulnerabilities/${cveId}`);
            if (!res.ok) throw new Error("Failed to fetch vulnerability details");
            return res.json();
        },
        enabled: !!cveId
    });

    const { data: relatedNews, isLoading: isNewsLoading } = useQuery<Article[]>({
        queryKey: ['/api/kev', cveId, 'related-articles'],
        queryFn: async () => {
            if (!cveId) return [];
            const res = await apiRequest('GET', `/api/kev/${cveId}/related-articles?limit=10`);
            if (!res.ok) return [];
            return res.json();
        },
        enabled: !!cveId
    });

    const handleSearch = (query: string) => setLocation('/');
    const handleBookmarksClick = () => setLocation('/');
    const handleSidebarToggle = () => setIsSidebarOpen(!isSidebarOpen);
    const handleSidebarClose = () => setIsSidebarOpen(false);
    const navigateToFeed = (params?: Record<string, string>) => {
        const query = params ? `?${new URLSearchParams(params).toString()}` : '';
        setLocation(`/threatfeed${query}`);
    };

    if (isKevLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-whatcyber-darker text-slate-100">
                <Loader2 className="w-10 h-10 animate-spin text-whatcyber-teal" />
            </div>
        );
    }

    if (!cveData?.kev && !cveData?.nvd) {
        return (
            <div className="min-h-screen bg-whatcyber-darker text-slate-100 flex flex-col">
                <Header
                    onSearch={handleSearch}
                    bookmarkCount={bookmarks.length}
                    onBookmarksClick={handleBookmarksClick}
                    onSidebarToggle={handleSidebarToggle}
                    isSidebarOpen={isSidebarOpen}
                />
                <div className="flex flex-1 min-h-0 relative">
                    <Sidebar
                        selectedSource="all"
                        onSourceSelect={(source) => navigateToFeed({ source })}
                        timeFilter="all"
                        onTimeFilterChange={(filter) => navigateToFeed({ timeFilter: filter })}
                        threatFilters={[]}
                        onThreatFilterChange={(filters) => navigateToFeed({ threatFilters: filters.join(',') })}
                        onClose={handleSidebarClose}
                        onVulnerabilitiesClick={() => navigateToFeed({ view: 'cveList' })}
                        onFollowSourcesClick={() => navigateToFeed({ view: 'followSources' })}
                        onBookmarksClick={() => navigateToFeed({ view: 'bookmarks' })}
                    />
                    <div className="flex-1 flex flex-col items-center justify-center gap-4">
                        <Shield className="w-16 h-16 text-slate-600" />
                        <h1 className="text-2xl font-bold text-slate-400">Vulnerability Not Found</h1>
                        <p className="text-slate-500">Could not find details for {cveId}</p>
                        <Button onClick={() => setLocation(matchKev ? '/exploited-vulnerabilities' : '/')}>
                            <ArrowLeft className="w-4 h-4 mr-2" />
                            Back to Catalog
                        </Button>
                    </div>
                </div>
            </div>
        );
    }

    const { kev: rawKev, nvd } = cveData;

    // Construct a usable vulnerability object (prefer KEV, fallback to NVD)
    const kev = rawKev || (nvd ? {
        cveID: nvd.id,
        vendorProject: nvd.vendors?.[0] || 'Unknown Vendor',
        product: 'Unknown Product',
        vulnerabilityName: 'Generic Vulnerability',
        dateAdded: nvd.publishedDate,
        shortDescription: nvd.description,
        requiredAction: 'Refer to NVD for remediation.',
        dueDate: null,
        knownRansomwareCampaignUse: 'Unknown',
        notes: null
    } as any : null);

    // Should we show KEV specific badges?
    const isKev = !!rawKev;
    const isOverdue = isKev && kev.dueDate ? new Date(kev.dueDate) < new Date() : false;

    // Severity color helper
    const getSeverityColor = (score: number | null | undefined) => {
        if (!score) return "bg-slate-600";
        if (score >= 9.0) return "bg-red-600";
        if (score >= 7.0) return "bg-orange-500";
        if (score >= 4.0) return "bg-yellow-500";
        return "bg-green-500";
    };

    const getSeverityText = (score: number | null | undefined) => {
        if (!score) return "text-slate-400";
        if (score >= 9.0) return "text-red-500";
        if (score >= 7.0) return "text-orange-400";
        if (score >= 4.0) return "text-yellow-400";
        return "text-green-400";
    }

    const cvssScore = nvd?.cvssV3Score ? Number(nvd.cvssV3Score) : (kev as any).cvssScore || 0; // Fallback if KEV has it

    return (
        <div className="min-h-screen bg-whatcyber-darker text-slate-100 flex flex-col">
            <SEO
                title={`${kev.cveID} - Exploited Vulnerability Details | WhatCyber`}
                description={`Details for ${kev.cveID}: ${kev.vulnerabilityName}. Action: ${kev.requiredAction}`}
                keywords={`${kev.cveID}, ${kev.vendorProject}, exploited vulnerability, CISA KEV`}
            />

            <Header
                onSearch={handleSearch}
                bookmarkCount={bookmarks.length}
                onBookmarksClick={handleBookmarksClick}
                onSidebarToggle={handleSidebarToggle}
                isSidebarOpen={isSidebarOpen}
            />

            <div className="flex flex-1 min-h-0 relative">
                {isSidebarOpen && (
                    <div
                        className="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden"
                        onClick={handleSidebarClose}
                    />
                )}
                <div className={`${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                    } fixed left-0 top-16 h-[calc(100vh-4rem)] z-30 lg:relative lg:translate-x-0 lg:z-10 lg:top-0 lg:h-full transition-transform duration-300 ease-in-out`}>
                    <Sidebar
                        selectedSource="all"
                        onSourceSelect={(source) => navigateToFeed({ source })}
                        timeFilter="all"
                        onTimeFilterChange={(filter) => navigateToFeed({ timeFilter: filter })}
                        threatFilters={[]}
                        onThreatFilterChange={(filters) => navigateToFeed({ threatFilters: filters.join(',') })}
                        onClose={handleSidebarClose}
                        onVulnerabilitiesClick={() => navigateToFeed({ view: 'cveList' })}
                        onFollowSourcesClick={() => navigateToFeed({ view: 'followSources' })}
                        onBookmarksClick={() => navigateToFeed({ view: 'bookmarks' })}
                    />
                </div>

                <main className="flex-1 overflow-y-auto bg-whatcyber-darker">
                    <div className="p-4 lg:p-8 pb-20 max-w-7xl mx-auto space-y-8">
                        {/* Breadcrumb / Back */}
                        <div className="flex items-center gap-2 text-sm text-slate-500">
                            <span onClick={() => setLocation(matchKev ? '/exploited-vulnerabilities' : '/')} className="hover:text-whatcyber-teal cursor-pointer hover:underline">
                                {matchKev ? 'Exploited Vulnerabilities' : 'Vulnerabilities'}
                            </span>
                            <span>/</span>
                            <span className="text-slate-300">{kev.cveID}</span>
                        </div>

                        {/* Top Summary Header */}
                        <div className="flex flex-col gap-6 border-b border-slate-700/50 pb-8">
                            <div className="flex flex-col lg:flex-row justify-between items-start gap-4">
                                <div className="space-y-4 max-w-4xl">
                                    <div className="flex flex-wrap items-center gap-3">
                                        <h1 className="text-3xl md:text-4xl font-bold font-mono text-slate-100 tracking-tight">{kev.cveID}</h1>
                                        {isKev && (
                                            <Badge variant="destructive" className="bg-red-500/10 text-red-500 border-red-500/20 px-3 py-1 text-sm font-medium flex items-center gap-1.5 h-7">
                                                <Activity className="w-3.5 h-3.5" />
                                                Active Exploitation
                                            </Badge>
                                        )}
                                        {kev.knownRansomwareCampaignUse === 'Known' && (
                                            <Badge variant="outline" className="bg-orange-500/10 text-orange-400 border-orange-500/20 px-3 py-1 flex items-center gap-1.5 h-7">
                                                <AlertTriangle className="w-3.5 h-3.5" />
                                                Ransomware Linked
                                            </Badge>
                                        )}
                                    </div>

                                    <h2 className="text-xl text-slate-200 font-semibold">{kev.vendorProject} {kev.product}</h2>
                                    <p className="text-base text-slate-400 leading-relaxed max-w-prose">{kev.vulnerabilityName}</p>
                                </div>

                                <div className="flex flex-col gap-3 min-w-[200px] lg:items-end">
                                    <div className="text-right">
                                        <div className="text-slate-500 text-xs uppercase tracking-wider font-semibold mb-1">Date Added</div>
                                        <div className="text-slate-200 font-medium">{format(new Date(kev.dateAdded), 'MMM dd, yyyy')}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-slate-500 text-xs uppercase tracking-wider font-semibold mb-1">CISA Due Date</div>
                                        <div className={`font-bold flex items-center justify-end gap-2 ${isOverdue ? 'text-red-400' : 'text-slate-200'}`}>
                                            {isOverdue && <AlertCircle className="w-4 h-4" />}
                                            {kev.dueDate ? format(new Date(kev.dueDate), 'MMM dd, yyyy') : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Grid Layout */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

                            {/* Left Column: Technical Analysis */}
                            <div className="lg:col-span-2 space-y-8">

                                {/* Description Card */}
                                <Card className="bg-slate-800 border-slate-700 shadow-lg">
                                    <CardHeader>
                                        <CardTitle className="text-slate-100 flex items-center gap-2">
                                            <Info className="w-5 h-5 text-whatcyber-teal" />
                                            Vulnerability Analysis
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-6">
                                        <div className="space-y-2">
                                            <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider">CISA Summary</h4>
                                            <p className="text-slate-200 leading-relaxed text-sm bg-slate-900/30 p-4 rounded-lg border border-slate-700/50">
                                                {kev.shortDescription}
                                            </p>
                                        </div>

                                        {nvd?.description && (
                                            <div className="space-y-2">
                                                <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider">Technical Details (NVD)</h4>
                                                <p className="text-slate-300 leading-relaxed text-sm">{nvd.description}</p>
                                            </div>
                                        )}
                                    </CardContent>
                                </Card>

                                {/* CVSS Scorecard - Only if NVD data exists */}
                                {nvd && (
                                    <Card className="bg-slate-800 border-slate-700 shadow-lg">
                                        <CardHeader>
                                            <CardTitle className="text-slate-100 flex items-center gap-2">
                                                <Activity className="w-5 h-5 text-whatcyber-teal" />
                                                Severity Score (CVSS v3)
                                            </CardTitle>
                                        </CardHeader>
                                        <CardContent>
                                            <div className="flex items-center gap-6">
                                                <div className={`relative w-24 h-24 flex items-center justify-center rounded-full border-4 ${cvssScore >= 9 ? 'border-red-500' : cvssScore >= 7 ? 'border-orange-500' : 'border-yellow-500'} bg-slate-900`}>
                                                    <span className={`text-2xl font-bold ${getSeverityText(cvssScore)}`}>{cvssScore || 'N/A'}</span>
                                                </div>
                                                <div className="flex-1 space-y-2">
                                                    <div className="flex justify-between items-center">
                                                        <span className={`font-bold text-lg ${getSeverityText(cvssScore)}`}>{nvd.cvssV3Severity || 'UNKNOWN'}</span>
                                                        <span className="text-slate-500 text-sm">Base Score</span>
                                                    </div>
                                                    <Progress value={(cvssScore || 0) * 10} className={`h-3 ${getSeverityColor(cvssScore)}`} />
                                                    <p className="text-xs text-slate-400 font-mono mt-2 break-all">
                                                        {/* Vector string not always available directly in schema shown, using NVD description context if parsed, else simplified */}
                                                        Target: {nvd.vulnStatus}
                                                    </p>
                                                </div>
                                            </div>
                                        </CardContent>
                                    </Card>
                                )}

                                {/* Weaknesses / CWEs */}
                                {nvd?.weaknesses && nvd.weaknesses.length > 0 && mapWeaknesses(nvd.weaknesses).length > 0 && (
                                    <div className="space-y-3">
                                        <h3 className="text-base font-semibold text-slate-300">Technical Weaknesses (CWE)</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {mapWeaknesses(nvd.weaknesses).map((cwe: string, idx: number) => (
                                                <Badge key={idx} variant="secondary" className="bg-slate-700 hover:bg-slate-600 text-slate-300 border-slate-600">
                                                    {cwe}
                                                </Badge>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Related News - Moved to Left Column */}
                                <div className="space-y-4">
                                    <h3 className="text-lg font-bold text-slate-100 flex items-center gap-2 border-b border-slate-700 pb-2">
                                        <Newspaper className="w-5 h-5 text-whatcyber-teal" />
                                        Related Intelligence
                                    </h3>
                                    <div className="space-y-3">
                                        {isNewsLoading ? (
                                            <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin text-slate-500" /></div>
                                        ) : !relatedNews?.length ? (
                                            <div className="text-center py-6 bg-slate-800/30 border border-dashed border-slate-700 rounded-lg text-slate-500 text-sm">
                                                No specific articles found linked to this CVE.
                                            </div>
                                        ) : (
                                            relatedNews.map(article => (
                                                <a
                                                    key={article.id}
                                                    href={article.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="block bg-slate-800 border-l-2 border-l-transparent hover:border-l-whatcyber-teal border-y border-r border-slate-700 hover:bg-slate-700/50 transition-all rounded p-3 group"
                                                >
                                                    <h4 className="font-semibold text-slate-200 group-hover:text-whatcyber-teal transition-colors text-sm line-clamp-2 mb-1">
                                                        {article.title}
                                                    </h4>
                                                    <div className="flex items-center justify-between text-xs text-slate-500">
                                                        <span className="font-medium text-slate-400">{article.source}</span>
                                                        <span>{format(new Date(article.publishedAt), 'MMM dd, yyyy')}</span>
                                                    </div>
                                                </a>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Right Column: Remediation & Intel */}
                            <div className="space-y-8">

                                {/* Required Action Card - Prominent */}
                                <Card className="bg-gradient-to-br from-slate-800 to-slate-900 border-l-4 border-l-whatcyber-teal border-y-slate-700 border-r-slate-700 shadow-xl">
                                    <CardHeader>
                                        <CardTitle className="text-whatcyber-teal flex items-center gap-2">
                                            <CheckCircle className="w-5 h-5" />
                                            Required Action
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <p className="text-slate-100 font-medium text-base leading-snug">
                                            {kev.requiredAction}
                                        </p>
                                        <div className="pt-4 border-t border-slate-700/50 flex flex-col gap-1">
                                            <span className="text-slate-500 text-xs uppercase tracking-wider">Due Date</span>
                                            <div className="flex items-center gap-2">
                                                <Clock className={`w-4 h-4 ${isOverdue ? 'text-red-400' : 'text-slate-400'}`} />
                                                <span className={`font-semibold ${isOverdue ? 'text-red-400' : 'text-slate-200'}`}>
                                                    {kev.dueDate ? format(new Date(kev.dueDate), 'MMMM dd, yyyy') : 'N/A'}
                                                </span>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>

                                {/* References List */}
                                {nvd?.referenceUrls && nvd.referenceUrls.length > 0 && (
                                    <Card className="bg-slate-800 border-slate-700">
                                        <CardHeader>
                                            <CardTitle className="text-slate-200 text-lg flex items-center gap-2">
                                                <Server className="w-4 h-4 text-slate-400" />
                                                Technical References
                                            </CardTitle>
                                        </CardHeader>
                                        <CardContent>
                                            <ul className="space-y-2">
                                                {nvd.referenceUrls.slice(0, 5).map((ref: any, idx: number) => (
                                                    <li key={idx}>
                                                        <a href={ref.url} target="_blank" rel="noreferrer" className="text-whatcyber-teal hover:underline text-sm truncate block flex items-center gap-2">
                                                            <ExternalLink className="w-3 h-3 shrink-0" />
                                                            <span className="truncate">{ref.url}</span>
                                                        </a>
                                                    </li>
                                                ))}
                                                {nvd.referenceUrls.length > 5 && (
                                                    <li className="text-slate-500 text-xs italic pt-1">
                                                        + {nvd.referenceUrls.length - 5} more references...
                                                    </li>
                                                )}
                                            </ul>
                                        </CardContent>
                                    </Card>
                                )}



                            </div>
                        </div>
                    </div>
                </main>
            </div >
        </div >
    );
}

// Helper: Ensure weaknesses are array of strings
function mapWeaknesses(w: any): string[] {
    if (Array.isArray(w)) return w;
    return [];
}
